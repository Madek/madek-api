task_defaults:
  traits:
    asdf-ruby: true

  environment_variables:
    WORKING_DIR: "{{CIDER_CI_WORKING_DIR}}/docs_source"

  git_options:
    submodules:
      include_match: .*docs.*|datalayer

  scripts:
    env:
      body: env | sort

    bundle:
      exclusive_executor_resource: asdf-ruby
      timeout: 20 Minutes
      body: |
        #!/usr/bin/env bash
        set -eux
        cd ${WORKING_DIR}
        asdf install ruby
        bundle install

tasks:
  docs:
    name: Docs are up to date
    scripts:
      test:
        start_when:
          bundled:
            script_key: bundle
        body: |
          #!/usr/bin/env bash
          set -eux
          cd ${WORKING_DIR}
          bundle exec middleman build
          cd ../docs
          git diff --exit-code --ignore-all-space
